---
title: "RPC（远程调用）技术详解"
date: 2025-02-06
tags:
  - Web开发
description: ""
---

## 目录
1. [RPC概述](#rpc概述)
2. [注册中心与动态IP管理](#注册中心与动态IP管理)
3. [RPC协议规范](#rpc协议规范)
4. [代理模式的本质](#代理模式的本质)
5. [网络通信问题：国内到新加坡的IP路由](#网络通信问题国内到新加坡的ip路由)
6. [泛化调用](#泛化调用)
7. [HSF泛化参数构造](#hsf泛化参数构造)

---

## RPC概述

RPC（Remote Procedure Call，远程过程调用）是一种让客户端能够像调用本地方法一样调用远程服务器上的方法的技术。其核心思想是通过网络实现跨进程或跨机器的函数调用。

---

## 注册中心与动态IP管理

在分布式系统中，**注册中心**（如ConfigCenter）用于管理服务的动态IP地址和元信息。它的主要作用包括：
- **服务注册**：服务启动时向注册中心注册自己的地址。
- **服务发现**：客户端通过注册中心获取目标服务的地址。
- **动态管理**：支持服务上下线、负载均衡等功能。

---

## RPC协议规范

RPC协议定义了客户端与服务端之间的通信规范。以下是一个典型的RPC请求格式示例：

```json
{
    "serviceName": "xxx",
    "methodName": "getList"
}
```

- `serviceName`：指定要调用的服务名称。
- `methodName`：指定要调用的方法名称。

该请求经过序列化后会变成一个字符串，通过网络传输到服务端进行反序列化和处理。

---

## 代理模式的本质

RPC的核心机制之一是**代理模式**。代理层位于客户端和服务端之间，负责处理以下任务：
- **序列化/反序列化**：将请求对象转换为字节流以便传输，并在接收端还原为对象。
- **网络通信**：负责数据包的发送和接收。
- **错误处理**：捕获并处理网络异常或服务端错误。

代理机制使得应用程序可以专注于业务逻辑本身，而无需关心底层的复杂性。

---

## 网络通信问题：国内到新加坡的IP路由

在国内访问新加坡的IP时，可能会遇到以下问题：
- **运营商拦截**：某些运营商可能会拦截特定的HTTPS请求。
- **DNS解析差异**：通过域名访问时，DNS返回的IP可能与直接`ping`得到的IP不同，导致访问失败。

**建议：**
- 在内部应用机器之间通信时，建议使用HTTP而非HTTPS，以避免证书卸载等问题。

---

## 泛化调用

泛化调用是一种不依赖具体接口定义的调用方式，适用于动态场景。以下是泛化调用的特点：
- **灵活性高**：无需提前定义接口，适合动态生成的请求。
- **兼容性强**：可以在不同语言或框架间实现通用调用。

---

## HSF泛化参数构造

HSF（High-Speed Service Framework）是阿里巴巴的一种高性能服务框架，支持泛化调用。以下是构造HSF泛化参数的关键步骤：

1. **确定服务名称和方法名称**：明确需要调用的服务和方法。
2. **构建参数列表**：根据方法签名构造参数。
3. **序列化请求**：将请求对象序列化为字节流。

**注意事项：**
- 参数类型需与服务端方法签名一致。
- 确保序列化方式与服务端兼容。

## 案例
node调用hsf， 入参是一个对象。 对象的字段不能是枚举，和List<自定义对象>

技术：
枚举改为string
自定义对象改为List`<<Map, String>>`类型

## RPC接口缓存

hsf是如何根据参数缓存的？

key: id(xxx)_method(get/post)_uid(唯一id) , 底层是一个`Map<string, Promise<any>>`