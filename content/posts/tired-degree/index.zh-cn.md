---
title: "客户端疲劳度控制方案详解"
date: 2025-02-06
tags:
  - Web开发
  - 工程
---

## 目录
1. [技术实现](#技术实现)
2. [业务分析](#业务分析)
   - [风险评估](#风险评估)
   - [疲劳度逻辑](#疲劳度逻辑)
3. [预案/限流/兜底](#预案限流兜底)
4. [可测性评估](#可测性评估)
5. [监控预警](#监控预警)

---

## 技术实现

- **覆盖式安装缓存**：  
  如果删除后重新安装，缓存会被清空。缓存通常存储在本地文件中，建议将相关逻辑集成到启动任务中。

---

## 业务分析

### 风险评估

1. **接口流量攻击**  
   - PC 端的请求依赖 JS 执行，因此流量攻击的风险相对较低。  
   - 服务端采用单机限流策略，并对接口 QPS 进行评估，确保系统稳定性。

2. **重复写/批量写的风险**  
   - 需要避免因重复写或批量写导致的数据异常问题。

3. **接口疲劳度**  
   - 定义接口请求的疲劳度规则：例如，端外每 10 次发起一次请求；如果未命中疲劳度规则，则不发起请求。  
   - 如果服务端修改了疲劳度值，需要第二次请求才会生效。

4. **新老版本升级**  
   - 老版本用户点击过的按钮，在新版本中应保持不可点击状态，避免重复触发。

5. **按钮疲劳度差异**  
   - 不同按钮的疲劳度可能不同，需针对具体场景进行差异化配置。

6. **不同埋点占比**  
   - 针对不同的埋点数据，设置合理的占比分配，以满足数据分析需求。

---

### 疲劳度逻辑

- **疲劳度定义**：  
  根据业务需求，为每个按钮或接口设置独立的疲劳度规则。  
  - 示例：  
    - 按钮 A：每 10 分钟允许点击一次。  
    - 按钮 B：每 24 小时允许点击一次。  

- **服务端更新疲劳度值**：  
  当服务端调整疲劳度规则时，客户端需在下一次请求时同步最新规则。

---

## 预案/限流/兜底

- **默认值返回**：  
  如果未命中疲劳度规则或发生异常，默认返回“不弹窗”状态，避免影响用户体验。

- **限流策略**：  
  - 单机限流：限制单台服务器的 QPS，防止过载。  
  - 接口限流：根据业务需求，设置接口级别的请求频率限制。

- **兜底方案**：  
  在极端情况下（如服务不可用），返回默认值或静态配置，确保系统可用性。

---

## 可测性评估

1. **测试方法**  
   - **Mock IP 测试**：通过模拟不同的 IP 地址，验证疲劳度规则是否正确应用。  
   - **修改系统时间**：调整系统时间，测试疲劳度的时间窗口逻辑是否符合预期。  

2. **客户端虚拟版本测试**  
   - 使用虚拟版本号模拟不同客户端版本，验证新老版本的兼容性和疲劳度逻辑。

---

## 监控预警

- **监控指标**  
  - 接口调用频率（QPS）。  
  - 疲劳度命中率（命中/未命中比例）。  
  - 异常请求占比（如超限、重复写等）。  

- **预警机制**  
  - 设置阈值报警：当接口 QPS 超过预设值时，触发报警。  
  - 日志记录：详细记录每次请求的疲劳度命中情况，便于问题排查。  

- **日志分析**  
  - 定期分析日志数据，评估疲劳度规则的实际效果，并优化规则配置。
