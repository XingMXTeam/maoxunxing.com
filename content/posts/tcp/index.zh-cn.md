---
title: "[WIP] TCP 总结"
date: 2022-04-02T12:56:49+08:00
tags:
  - TCP
---


## 目录

1. [RFC 1180 - TCP/IP 教程](#rfc-1180---tcpip-教程)
2. [《TCP/IP 卷》推荐](#tcpip-卷推荐)
3. [《Wireless 抓包艺术》推荐](#wireless-抓包艺术推荐)
4. [TCP 三次握手](#TCP-三次握手)
5. [四次挥手](#四次挥手)
6. [TIME-WAIT](#TIME-WAIT)
7. [重传机制](#重传机制)

---

## RFC 1180 - TCP/IP 教程

### 概述
[RFC 1180](https://datatracker.ietf.org/doc/html/rfc1180?spm=ata.21736010.0.0.7fef5b82m2OFdt) 是一份经典的 TCP/IP 教程文档，由 IETF 发布，旨在帮助初学者理解 TCP/IP 协议栈的基本概念和工作原理。

### 主要内容
- **TCP/IP 基础**：介绍协议栈的分层结构（应用层、传输层、网络层、链路层）。
- **IP 协议**：详细讲解 IP 地址、子网划分、路由选择等内容。
- **TCP 和 UDP**：对比两种传输协议的特点及适用场景。
- **常见应用层协议**：如 HTTP、FTP、SMTP 等的工作机制。

### 阅读建议
- 适合对计算机网络有一定基础的读者。
- 结合实际网络环境进行实验验证，例如通过抓包工具观察协议交互过程。

---

## 《TCP/IP 卷》

《TCP/IP 卷》是一套经典的计算机网络书籍，深入剖析了 TCP/IP 协议栈的设计与实现细节。该系列书籍通常分为多卷，涵盖从基础理论到高级应用的全面内容。

---

## 《Wireless 抓包艺术》推荐

### 概述
《Wireless 抓包艺术》是一本专注于无线网络抓包技术的书籍，重点讲解如何利用抓包工具分析无线通信数据流，揭示隐藏在无线信号中的信息。

### 主要内容
- **无线网络基础**：包括 Wi-Fi、蓝牙等无线通信协议的基本原理。
- **抓包工具使用**：详细介绍 Wireshark、AirPcap 等工具的操作方法。
- **数据分析技巧**：如何解读抓包结果，识别异常流量或潜在安全威胁。
- **实战案例**：通过真实场景演示抓包技术的应用价值。

### 学习建议
- **熟悉基础知识**：在学习本书之前，建议先掌握基本的网络知识。
- **注重实操**：准备一台支持无线抓包的设备，边学边练。
- **关注安全性**：了解抓包可能涉及的法律和道德问题，避免滥用技术。

---

## TCP 三次握手

- Host1发送`SYN`，进入`SYN-SENT`状态。
   - **发起方（Host1）**向**接收方（Host2）**发送一个带有`SYN`标志的TCP报文段。这个报文段包含一个随机生成的初始序列号（ISN，Initial Sequence Number），用于标识后续数据流的起点。
- Host2收到`SYN`，进入`SYN-RECEIVED`状态，并发送`SYN-ACK`。
   - **接收方（Host2）**收到Host1的`SYN`报文后，会回复一个带有`SYN`和`ACK`标志的TCP报文段。
   - Host2也会生成自己的初始序列号（`y`），并通过`SYN`发送给Host1。
   - 同时，Host2通过`ACK`确认收到Host1的`SYN`，并将确认号设置为`x+1`（表示期望收到的下一个字节）。
   - 此时，Host2进入`SYN-RECEIVED`状态。
- Host1收到`SYN-ACK`，发送`ACK`，双方进入`ESTABLISHED`状态。
   - **发起方（Host1）**收到Host2的`SYN-ACK`报文后，会发送一个带有`ACK`标志的TCP报文段。
   - Host1将确认号设置为`y+1`，表示期望收到Host2的下一个字节。
   - 此时，Host1和Host2都进入`ESTABLISHED`状态，连接成功建立，可以开始数据传输。


### **总结三次握手的状态变化**
- **Host1**:
  1. 初始状态：`CLOSED`
  2. 发送`SYN`后：`SYN-SENT`
  3. 收到`SYN-ACK`后：`ESTABLISHED`

- **Host2**:
  1. 初始状态：`LISTEN`
  2. 收到`SYN`后：`SYN-RECEIVED`
  3. 收到`ACK`后：`ESTABLISHED`

### **为什么需要三次握手？**
1. **协商初始序列号**：
   - TCP使用序列号来保证数据包的顺序性和可靠性。三次握手允许双方交换各自的初始序列号，从而为后续的数据传输做好准备。

2. **防止历史连接的影响**：
   - 如果网络中存在延迟或重复的旧连接请求，三次握手可以检测到这些无效请求并丢弃它们，避免错误连接。

3. **双向确认**：
   - 确保双方都能正常收发数据。例如，Host1确认Host2能收到数据，Host2也确认Host1能收到数据。


## 四次挥手

- 第一次挥手：发送 FIN（主动关闭方发起）
   - Host1（主动关闭方）决定关闭连接，向Host2发送一个带有FIN标志的报文段。FIN表示“我已没有数据要发送了”。此时，Host1进入FIN-WAIT-1状态。
- 第二次挥手：发送 ACK（被动关闭方响应）
   - Host2收到Host1的FIN后，会回复一个带有ACK标志的报文段。
      - ACK确认号设置为x+1，表示已收到Host1的FIN。
      - 此时，Host2进入CLOSE-WAIT状态，而Host1进入FIN-WAIT-2状态。
      - 注意：此时Host2可能仍然有数据要发送给Host1，因此连接并未完全关闭。
- 第三次挥手：发送 FIN（被动关闭方发起）
   - 当Host2完成所有数据传输后，也会发送一个带有FIN标志的报文段，表示“我也已没有数据要发送了”。此时，Host2进入LAST-ACK状态。
- 第四次挥手：发送 ACK（主动关闭方响应）
   - Host1收到Host2的FIN后，会回复一个带有ACK标志的报文段。
   - ACK确认号设置为y+1，表示已收到Host2的FIN。
   - 此时，Host1进入TIME-WAIT状态，而Host2直接进入CLOSED状态。


## TIME-WAIT

在TCP连接关闭的过程中，当一方（例如Host1）发送最后一个`ACK`确认报文（第四次挥手）后，会进入`TIME-WAIT`状态。在此状态下，该方会等待一段时间（通常是**2倍的最大报文生存时间，2 * MSL**），然后才完全关闭连接。

- **MSL (Maximum Segment Lifetime)**：最大报文生存时间，表示一个TCP报文在网络中能够存在的最长时间。通常设置为2分钟，因此`TIME-WAIT`的时间通常是4分钟。

### 为什么需要 TIME-WAIT

#### **(1) 确保最后的 ACK 被接收**
在TCP连接关闭时，双方通过四次挥手（Four-Way Handshake）来终止连接。如果Host1发送的最后一个`ACK`丢失，Host2将无法确认连接已成功关闭，并会重新发送`FIN`消息。如果没有`TIME-WAIT`状态，Host1可能会直接关闭连接，导致Host2永远无法收到确认，从而陷入错误状态。

通过保持`TIME-WAIT`状态，Host1可以继续监听网络，如果收到Host2重发的`FIN`，可以再次发送`ACK`以完成连接关闭。

#### **(2) 清理网络中的延迟报文**
网络中可能存在延迟或重复的报文段（例如由于路由问题或网络拥塞）。如果连接立即关闭，这些滞留的报文可能会被误认为是新连接的一部分，从而导致数据混乱。

`TIME-WAIT`状态的存在确保了所有与当前连接相关的报文都能在网络中消失，避免它们干扰后续的新连接。

#### **(3) 避免旧连接的报文影响新连接**
TCP使用四元组（源IP、源端口、目标IP、目标端口）来标识一个连接。如果一个连接关闭后立即重新使用相同的四元组建立新连接，那么旧连接中滞留的报文可能会被误认为属于新连接，从而导致数据污染或协议错误。

通过等待`TIME-WAIT`时间，可以确保旧连接的所有报文都已过期，从而安全地复用四元组。

## 重传机制

TCP 使用确认机制（ACK）来确保数据包被成功接收。如果发送方在一定时间内未收到接收方的确认（ACK），就会触发重传机制。

- 超时重传（RTO, Retransmission Timeout）：
   - 发送方为每个数据包设置一个超时时间（RTO，Retransmission Timeout）。
   - 如果在 RTO 时间内未收到 ACK，发送方会重新发送该数据包。
- 快速重传（Fast Retransmit）：
   - 如果接收方检测到数据包丢失（例如收到乱序的数据包），会连续发送多个重复的 ACK。
   - 当发送方收到 3 个重复的 ACK 时，会立即重传丢失的数据包，而无需等待 RTO 超时。